<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Basket</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- QR Code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; margin:0; padding:0; }
    header { background: #007bff; color:white; padding:15px; text-align:center; font-size:20px; font-weight:600; }
    .basket-container { max-width:600px; margin:20px auto; padding:0 15px; }
    .basket-card { display:flex; align-items:center; background:white; padding:15px; margin:10px 0; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .product-icon { font-size:28px; margin-right:15px; }
    .product-info h3 { margin:0; font-weight:600; font-size:16px; }
    .product-info p { margin:3px 0 0; color:#555; }
    .qr-container { text-align:center; margin:20px 0; display:none; }
    footer { position:fixed; bottom:0; left:0; right:0; background:#fff; padding:15px; box-shadow:0 -2px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .total { font-size:18px; font-weight:600; }
    .btn-checkout { background:#28a745; color:white; padding:12px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer; transition:0.3s; }
    .btn-checkout:hover { background:#218838; }
    .toast { visibility:hidden; min-width:250px; background:#007bff; color:white; text-align:center; border-radius:8px; padding:16px; position:fixed; z-index:9999; left:50%; bottom:30px; transform:translateX(-50%); font-size:16px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    .toast.show { visibility:visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom:0; opacity:0;} to {bottom:30px; opacity:1;} }
    @keyframes fadeout { from {bottom:30px; opacity:1;} to {bottom:0; opacity:0;} }
    @media (max-width:480px) { .basket-card { flex-direction:column; align-items:flex-start; } .product-icon { margin-bottom:8px; } footer { flex-direction:column; text-align:center; } .btn-checkout { margin-top:10px; width:100%; } .total { margin-bottom:10px; } }
  </style>
</head>
<body>
<header>üõí Smart Basket</header>

<div class="basket-container" id="basket"></div>
<div class="qr-container" id="qr" style="display: none;"></div>


<footer>
  <div class="total" id="total">Total: ‚Ç±0</div>
  <button class="btn-checkout" onclick="checkout()">Checkout</button>
</footer>

<div id="toast" class="toast">Basket updated!</div>

<!-- ... (everything above remains unchanged) ... -->

<script>
const backend = "https://sabrina-backend-mwqy.onrender.com";
const basketId = "basket001"; // Adjust if needed

let previousItems = new Map();

function hasBasketChanged(items) {
  const newItems = new Map(items.map(i => [i.uidItem, i.quantity]));
  if (newItems.size !== previousItems.size) return true;
  for (let [uid, qty] of newItems) {
    if (!previousItems.has(uid) || previousItems.get(uid) !== qty) return true;
  }
  return false;
}

// Load basket from backend every 2 seconds
async function loadBasket() {
  try {
    const res = await fetch(`${backend}/basket/${basketId}`);
    const basket = await res.json();

    if (!basket || !Array.isArray(basket.items)) return;

    const newItems = new Map(basket.items.map(i => [i.uidItem, i.quantity]));
    const changed = hasBasketChanged(basket.items);

    if (changed) {
      const basketContainer = document.getElementById("basket");
      basketContainer.innerHTML = "";

      let total = 0;
      basket.items.forEach(item => {
        const quantity = item.quantity || 1;
        total += item.itemPrice * quantity;

        const card = document.createElement("div");
        card.className = "basket-card";

        const icon = document.createElement("div");
        icon.className = "product-icon";
        icon.textContent = "üì¶";

        const info = document.createElement("div");
        info.className = "product-info";
        info.innerHTML = `
          <h3>${item.itemName}</h3>
          <p>‚Ç±${item.itemPrice} √ó 
            <button onclick="updateQuantity('${item.uidItem}', -1)">‚àí</button>
            <span id="qty-${item.uidItem}">${quantity}</span>
            <button onclick="updateQuantity('${item.uidItem}', 1)">+</button>
          </p>
        `;

        card.appendChild(icon);
        card.appendChild(info);
        basketContainer.appendChild(card);
      });

      document.getElementById("total").textContent = `Total: ‚Ç±${total}`;
      previousItems = newItems;
      showToast("üõí Basket updated!");
    }
  } catch (err) {
    console.error(err);
    showToast("‚ùå Failed to load basket");
  }
}

// Update item quantity
async function updateQuantity(uid, delta) {
  try {
    const res = await fetch(`${backend}/basket/update-quantity`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ basketId, uidItem: uid, delta })
    });

    const result = await res.json();
    if (result.success) {
      loadBasket(); // Refresh basket
    } else {
      showToast("‚ö†Ô∏è Could not update quantity");
    }
  } catch (err) {
    console.error(err);
    showToast("‚ùå Error updating quantity");
  }
}

// Checkout ‚Üí generate QR, keep basket for cashier
async function checkout() {
  try {
    const res = await fetch(`${backend}/basket/checkout`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ basketId })
    });

    const data = await res.json();
    if (!data.qrData) throw new Error("No QR data returned");

    const qrContainer = document.getElementById("qr");

    // Step 1: Make visible BEFORE generating QR
    qrContainer.style.display = "block";

    // Step 2: Clear previous QR (if any)
    qrContainer.innerHTML = "";

    // Step 3: Generate QR as <img> (works even if container was hidden before)
    QRCode.toDataURL(data.qrData, { width: 220 }, function(err, url) {
      if (err) {
        console.error(err);
        showToast("‚ùå Failed to generate QR");
      } else {
        qrContainer.innerHTML = `<img src="${url}" alt="QR Code">`;
        showToast("‚úÖ Show this QR to cashier");
      }
    });

  } catch (err) {
    console.error(err);
    showToast("‚ùå Checkout failed");
  }
}

// Toast notification
function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "toast show";
  setTimeout(() => toast.className = toast.className.replace("show",""), 3000);
}

// Start periodic basket load
setInterval(loadBasket, 2000);
loadBasket();
</script>

