<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>S.A.B.R.I.N.A.</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

  <!-- QR Code library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <!-- Hosted via Content Delievery Network not Locally -->

  <style>
    body { font-family: 'Poppins', sans-serif; background: #f4f6f9; margin:0; padding:0; }
    header { background: #007bff; color:white; padding:15px; text-align:center; font-size:20px; font-weight:600; }
    .basket-container { max-width:600px; margin:20px auto; padding:0 15px; }
    .basket-card { display:flex; align-items:center; background:white; padding:15px; margin:10px 0; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .product-icon { font-size:28px; margin-right:15px; }
    .product-info h3 { margin:0; font-weight:600; font-size:16px; }
    .product-info p { margin:3px 0 0; color:#555; }
    .qr-container { text-align:center; margin:20px 0; display:none; }
    footer { position:fixed; bottom:0; left:0; right:0; background:#fff; padding:15px; box-shadow:0 -2px 6px rgba(0,0,0,0.1); display:flex; justify-content:space-between; align-items:center; }
    .total { font-size:18px; font-weight:600; }
    .btn-checkout { background:#28a745; color:white; padding:12px 20px; border:none; border-radius:8px; font-size:16px; cursor:pointer; transition:0.3s; }
    .btn-checkout:hover { background:#218838; }
    .toast { visibility:hidden; min-width:250px; background:#007bff; color:white; text-align:center; border-radius:8px; padding:16px; position:fixed; z-index:9999; left:50%; bottom:30px; transform:translateX(-50%); font-size:16px; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
    .toast.show { visibility:visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
    @keyframes fadein { from {bottom:0; opacity:0;} to {bottom:30px; opacity:1;} }
    @keyframes fadeout { from {bottom:30px; opacity:1;} to {bottom:0; opacity:0;} }
    @media (max-width:480px) { .basket-card { flex-direction:column; align-items:flex-start; } .product-icon { margin-bottom:8px; } footer { flex-direction:column; text-align:center; } .btn-checkout { margin-top:10px; width:100%; } .total { margin-bottom:10px; } }
  </style>
</head>
<body>
<header>S.A.B.R.I.N.A.</header>
  <!-- The overall design of the page (fonts, toasts, fonts) -->

<div class="basket-container" id="basket"></div>
<div class="qr-container" id="qr" style="display: none;"></div>


<footer>
  <div class="total" id="total">Total: â‚±0</div>
  <button class="btn-checkout" onclick="checkout()">Checkout</button>
</footer>

<div id="toast" class="toast">Basket updated!</div>

<!-- ... (everything above concerns the websites overall design) ... -->

<script>
const backend = "https://sabrina-backend-mwqy.onrender.com";
const basketId = "basket001"; 
// defines the backend API via URL and sets a unique Id for the basket

let previousItems = new Map();
// keeps track of previous items to detect changes

function hasBasketChanged(items) {   // compares new basket with old basket to detect changes
  const newItems = new Map(items.map(i => [i.uidItem, i.quantity])); // makes use of Key-Value (UID, QUANTITY) 
  if (newItems.size !== previousItems.size) return true; // quantity change
  for (let [uid, qty] of newItems) {
    if (!previousItems.has(uid) || previousItems.get(uid) !== qty) return true; //uid change
  }
  return false;
  // if no changes then return false the basket doesnt have to change, if changes then the basket has to change
}
  

// fetches the latest basket data from the backend every 2 seconds
async function loadBasket() {
  try {
    const res = await fetch(`${backend}/basket/${basketId}`); //sends request to backend 
    const basket = await res.json(); //converts the received raw data (text) to JSON (parses that raw text into a working javascript object we can work with)

    if (!basket || !Array.isArray(basket.items)) return; //safety check 

    const newItems = new Map(basket.items.map(i => [i.uidItem, i.quantity])); //build a map of the new basket items
    const changed = hasBasketChanged(basket.items); //checks to see if the basket has changed 

    if (changed) {
      const basketContainer = document.getElementById("basket");
      basketContainer.innerHTML = ""; // if changed clears the old basket display

      let total = 0; 
      basket.items.forEach(item => {
        const quantity = item.quantity || 1;
        total += item.itemPrice * quantity; // calculates total price by multiplying item price and quantity

        const card = document.createElement("div");
        card.className = "basket-card"; //creates a card for the new item

        const icon = document.createElement("div");
        icon.className = "product-icon";
        icon.textContent = "ðŸ“¦"; // adds an icon for the new card

        // sets product info (item name, item price, also incharge for the quantity buttons
        const info = document.createElement("div");
        info.className = "product-info";
        info.innerHTML = `
          <h3>${item.itemName}</h3>
          <p>â‚±${item.itemPrice} Ã— 
            <button onclick="updateQuantity('${item.uidItem}', -1)">âˆ’</button>
            <span id="qty-${item.uidItem}">${quantity}</span>
            <button onclick="updateQuantity('${item.uidItem}', 1)">+</button>
          </p> 
        `;

        card.appendChild(icon);
        card.appendChild(info);
        basketContainer.appendChild(card);
        // assembles card info and then places the info inside the container in the page
      });
// updates total price
      document.getElementById("total").textContent = `Total: â‚±${total}`;
      previousItems = newItems;
      showToast("Basket updated!"); //shows a toast notification for success
    }
  } catch (err) {
    console.error(err);
    showToast("Failed to load basket"); // if error occurs then failed to load basket
  }
}

// Update item quantity
  // triggers when customer presses the + - button which sends a request to the backend to adjust the quantity of the item
  // if successful reload display then updates total and reload display

  
async function updateQuantity(uid, delta) { // declares an async function 
  try {
    const res = await fetch(`${backend}/basket/update-quantity`, { //command to send API POST to backend endpoint 
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ basketId, uidItem: uid, delta })
    });

    const result = await res.json(); //converts data received into workable javascript object
    if (result.success) {
      loadBasket(); // Refresh basket
    } else {
      showToast("Could not update quantity");
    }
  } catch (err) {
    console.error(err);
    showToast("Error updating quantity");
  }
}

// Checkout â†’ generate QR, keep basket for cashier
async function checkout() {
  try {
    const res = await fetch(`${backend}/basket/checkout`, { //sends a POST request to the backend endpoint
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ basketId }) //includes the ID so the server knows which basket to checkout
    });

    const data = await res.json(); //converts received data (qr data = basket001 : checkout) into JSON 
    if (!data.qrData) throw new Error("No QR data returned");

    const qrContainer = document.getElementById("qr");

    // Step 1: Make visible BEFORE generating QR
    qrContainer.style.display = "block";

    // Step 2: Clear previous QR (if any)
    qrContainer.innerHTML = "";

    // Step 3: Generate QR as <img> (works even if container was hidden before)
    QRCode.toDataURL(data.qrData, { width: 220 }, function(err, url) {
      if (err) {
        console.error(err);
        showToast("Failed to generate QR");
      } else {
        qrContainer.innerHTML = `<img src="${url}" alt="QR Code">`;
        showToast("Show this QR to cashier");
      }
    });

  } catch (err) {
    console.error(err);
    showToast("Checkout failed");
  }
}

// Toast notification
function showToast(message) {
  const toast = document.getElementById("toast");
  toast.textContent = message;
  toast.className = "toast show";
  setTimeout(() => toast.className = toast.className.replace("show",""), 3000);
}

// Start periodic basket load
setInterval(loadBasket, 2000);
loadBasket();
</script>

